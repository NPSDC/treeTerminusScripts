---
title: "min sum SPL Cut"
author: "Noor Pratap Singh"
date: "5/9/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = '/fs/cbcb-lab/rob/students/noor/Uncertainity/treeTerminusScripts')
```

```{r}
load("environment/brain_sim_nodtu/mode=gc_bias/post_type=gibbs_nrep=100_tf=100/yAll.RData")
load("environment/brain_sim_nodtu/mode=gc_bias/post_type=gibbs_nrep=100_tf=100/y.RData")
load("environment/brain_sim_nodtu/mode=gc_bias/post_type=gibbs_nrep=100_tf=100/tree.RData")
load("environment/brain_sim_nodtu/mode=gc_bias/mapDf.RData")
suppressPackageStartupMessages(source("tree_helper_function.R"))
suppressPackageStartupMessages(source("brain_simulation_nodtu/mode=gc_bias/post_type=gibbs_nrep=100_tf=100/tree_analysis/tree_filter.R"))
suppressPackageStartupMessages(library(ggplot2))
suppressPackageStartupMessages(library(ggpubr))
```

#### Minimizing SPL
```{r}
treeNoThrDir <- "../brain_sim_nodtu/mode=gc_bias/post_type=gibbs_nrep=100_tf=100/out_term_temp"
treeThrDir <- "../brain_sim_nodtu/mode=gc_bias/post_type=gibbs_nrep=100_tf=100/out_term_hirak"
samples <- as.vector(outer(c(1:6), c(1,2), function(x,y) paste(x,y,sep="_")))
treeListNoThr <- file.path(treeNoThrDir, samples, "group_nwk.txt")
treeListNoThr <- lapply(treeListNoThr, read.tree)

treeListThr <- file.path(treeThrDir, samples, "group_nwk.txt")
treeListThr <- lapply(treeListThr, read.tree)

dfSPL <- data.frame(matrix(nrow=0, ncol=3)) ### spl, optSPL, sample
colnames(dfSPL) <- c("spl", "optSPL", "sample")
dfSPLComp <- data.frame(matrix(nrow=0, ncol=4)) ### tree_term_nothr, tree_term_no_term_group, transcripts
colnames(dfSPLComp) <- c( "Sample", "TreeTerm_opt", "TreeTerm_groups", "Transcripts")
bCuts <- list()

for(i in seq_along(treeListNoThr)) {
    print(i)
    tr <- mergeTree(treeListNoThr[[i]], se = mapDf)
    trThr <- mergeTree(treeListThr[[i]], se = mapDf)
    txps <- union(tr$tip, trThr$tip)
    yR <- y[txps,]
    mB <- mergeLeaves(tr, yR)
    yR <- mB[["ySwish"]]
    tr <- mB[["tree"]]
    yAgg <- prepSwish(tr, yR)
    children <- Descendants(tr, nrow(yR)+1, "children")
    print("Agg completed")
    spl <- compSPL(yAgg, i=i, mv=F)
    print("spl completed")
    globArr <- rep(-100, nrow(yAgg))
    lengths <- sapply(Descendants(tr, seq(nrow(yAgg))), length)
    
    optSPL <- findOptSum(tr, spl, nrow(yR)+1, lengths)
    print("opt SPL completed")
    bCuts[[i]] <- findCuts(tr, globArr, spl, nrow(yR)+1,lengths)
    print("opt cuts found")
    dfSPL <- rbind(dfSPL, data.frame(spl = spl, optSPL = globArr, sample = samples[i]))
    dComp <- data.frame("Sample"=samples[i],"TreeTerm_opt"=sum(globArr[bCuts[[i]]]),
                "TreeTerm_groups" = sum(spl[children]*lengths[children]),
                "Transcripts" = sum(spl[1:nrow(yR)]))
    
    ### Hirak terminus
    mB <- mergeLeaves(trThr, yR)
    yR <- mB[["ySwish"]]
    trThr <- mB[["tree"]]
    
    yAgg <- prepSwish(trThr, yR)
    childrenThr <- Descendants(trThr, nrow(yR)+1, "children")
    
    spl <- compSPL(yAgg, i=i, mv=F)
    print("spl completed")
    globArr <- rep(-100, nrow(yAgg))
    lengths <- sapply(Descendants(trThr, seq(nrow(yAgg))), length)
    
    optSPL <- findOptSum(trThr, spl, nrow(yR)+1, lengths)
    print("opt SPL completed")
    cs <- findCuts(trThr, globArr, spl, nrow(yR)+1,lengths)
    print("opt cuts found")
    
    dComp <- cbind(dComp, data.frame("Term_opt"=sum(globArr[cs]),
                "Term_groups" = sum(spl[childrenThr]*lengths[childrenThr])))
    dfSPLComp <- rbind(dfSPLComp, dComp)
}

dfS <- reshape2::melt(dfSPLComp)
```

```{r}
ggplot(dfS, aes(x=variable, log10(value))) + geom_violin()
save(dfSPLComp, file = "environment/brain_sim_nodtu/mode=gc_bias/post_type=gibbs_nrep=100_tf=100/comp_trees/dfSPLComp.RData")
save(dfSPL, file = "environment/brain_sim_nodtu/mode=gc_bias/post_type=gibbs_nrep=100_tf=100/comp_trees/dfSPL.RData")
save(bCuts, file = "environment/brain_sim_nodtu/mode=gc_bias/post_type=gibbs_nrep=100_tf=100/comp_trees/bCuts.RData")
```